name: Build WSL2 Kernel with Binder

on:
  workflow_dispatch: # 手动触发按钮
  push:
    branches: [ main ]
    paths-ignore: # 忽略README等文件变更触发
      - '**/*.md'
      - '.gitignore'
  
# 设置环境变量，方便管理
env:
  KERNEL_REPO: "https://github.com/microsoft/WSL2-Linux-Kernel.git"
  KERNEL_BRANCH: "linux-msft-wsl-6.1.y"

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 360 # 编译可能很慢，设置6小时超时

    steps:
      # 1. 检出本仓库代码（含脚本）
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. 配置Git（用于克隆内核仓库）
      - name: Configure Git
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"

      # 3. 设置缓存，加速后续编译
      - name: Cache kernel source
        uses: actions/cache@v4
        id: cache-kernel
        with:
          path: WSL2-Linux-Kernel
          key: kernel-${{ env.KERNEL_BRANCH }}-${{ hashFiles('scripts/setup_config.sh') }}
          restore-keys: |
            kernel-${{ env.KERNEL_BRANCH }}-

      # 4. 获取内核源码（缓存未命中时）
      - name: Fetch kernel source
        if: steps.cache-kernel.outputs.cache-hit != 'true'
        run: |
          echo "正在克隆内核源码（分支: ${{ env.KERNEL_BRANCH }}）..."
          if [ -d "WSL2-Linux-Kernel" ]; then
            echo “检测到旧目录，清理中...”
            rm -rf WSL2-Linux-Kernel
          fi
          git clone --depth 1 \
            --branch ${{ env.KERNEL_BRANCH }} \
            ${{ env.KERNEL_REPO }} \
            WSL2-Linux-Kernel
          echo "源码克隆完成！"

      # 5. 准备编译环境
      - name: Setup build environment
        run: |
          echo "安装编译依赖..."
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            flex \
            bison \
            libssl-dev \
            libelf-dev \
            bc \
            kmod \
            cpio \
            libncurses-dev \
            dwarves
      
      # 6. 检查目录是否正常
      - name: Debug Directory Structure
        run: |
          echo “当前工作目录:”
          pwd
          echo “”
          echo “列出所有文件和目录:”
          ls -la
          echo “”
          echo “列出 scripts 目录内容:”
          ls -la scripts/ 2>/dev/null || echo “scripts 目录不存在！”

      # 7. 配置内核（运行我们的脚本）
      - name: Configure kernel (诊断模式)
        run: |
          chmod +x scripts/setup_config.sh
          cd WSL2-Linux-Kernel

          echo "=== 1. 执行配置脚本前，先查看原始配置中ASHMEM的状态 ==="
          grep -i "ASHMEM" .config || echo "初始状态: 未找到ASHMEM配置"

          echo "=== 2. 执行我们的配置脚本 ==="
          ../scripts/setup_config.sh

          echo "=== 3. 脚本执行后，立即查看.config文件 ==="
          cat .config | grep -i "ASHMEM" || echo "脚本执行后: 仍未找到ASHMEM配置"
          echo "--- 同时检查ANDROID和SHMEM ---"
          grep -E "^(CONFIG_ANDROID|CONFIG_SHMEM)=" .config || echo "未找到"

          echo "=== 4. 执行 'make olddefconfig' 并观察变化 ==="
          cp .config .config.before_olddefconfig
          make olddefconfig
          echo "--- 比较 olddefconfig 前后的差异 (重点关注ASHMEM) ---"
          diff -u .config.before_olddefconfig .config | grep -i ashmem || echo "差异中未发现ASHMEM变化"

          echo "=== 5. 最终 .config 文件状态 ==="
          echo "ASHMEM相关:"
          grep -i ashmem .config || echo "(无)"
          echo "..."
          echo "如果最终仍未启用，我们将采用备用方案直接修改。"

      # 8. 编译内核（运行我们的脚本）
      - name: Compile kernel
        run: |
          chmod +x scripts/build_kernel.sh
          ./scripts/build_kernel.sh

      # 9. 上传产出物（便于下载）
      - name: Upload kernel artifacts
        uses: actions/upload-artifact@v4
        with:
          name: wsl2-custom-kernel
          path: kernel_output/
          retention-days: 7

      # 10. 创建GitHub Release（仅在打Tag时触发）
      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: kernel_output/*
          generate_release_notes: true